<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFCompare</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #3b82f6;
            --green: #22c55e;
            --red: #ef4444;
            --yellow: #eab308;
            --green-bg: #052e16;
            --red-bg: #350a0a;
            --yellow-bg: #352a04;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

        a.skip-link {
            position: absolute; left: -9999px; top: 0; z-index: 100;
            background: var(--accent); color: #fff; padding: .5rem 1rem; border-radius: 0 0 6px 0;
        }
        a.skip-link:focus { left: 0; }

        header { padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
        header h1 { font-size: 1.5rem; font-weight: 700; }
        header span { color: var(--muted); font-size: .9rem; }

        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem; }

        /* Drop zone */
        .drop-area { display: flex; gap: 2rem; margin-bottom: 1.5rem; }
        .drop-zone {
            flex: 1; border: 2px dashed var(--border); border-radius: 12px;
            padding: 2.5rem 1.5rem; text-align: center; cursor: pointer;
            transition: border-color .2s, background .2s; position: relative;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: rgba(59,130,246,.06); }
        .drop-zone:focus-within { border-color: var(--accent); outline: 2px solid var(--accent); outline-offset: 2px; }
        .drop-zone.has-file { border-color: var(--green); }
        .drop-zone input { display: none; }
        .drop-zone h3 { margin-bottom: .5rem; }
        .drop-zone p { color: var(--muted); font-size: .85rem; }
        .drop-zone .filename { color: var(--green); margin-top: .5rem; font-weight: 600; word-break: break-all; }

        /* Settings panels */
        .settings-row { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .settings-row > details { flex: 1; }
        details.panel {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            padding: 1rem 1.25rem;
        }
        details.panel summary {
            cursor: pointer; font-weight: 600; font-size: .9rem; user-select: none;
            list-style: none; display: flex; align-items: center; gap: .5rem;
        }
        details.panel summary:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        details.panel summary::before { content: "\25B6"; font-size: .65rem; transition: transform .2s; }
        details.panel[open] summary::before { transform: rotate(90deg); }
        details.panel .fields { display: grid; grid-template-columns: 1fr 1fr; gap: .6rem 1.25rem; margin-top: .75rem; }
        details.panel label { font-size: .8rem; color: var(--muted); display: flex; flex-direction: column; gap: .25rem; }
        details.panel label.inline { flex-direction: row; align-items: center; gap: .5rem; }
        details.panel select, details.panel input[type="text"], details.panel input[type="password"] {
            padding: .45rem .6rem; border-radius: 6px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); font-size: .82rem;
        }
        details.panel input[type="checkbox"] { width: 1rem; height: 1rem; accent-color: var(--accent); }
        details.panel select:focus-visible, details.panel input:focus-visible {
            outline: 2px solid var(--accent); outline-offset: 1px;
        }
        details.panel .hint { font-size: .72rem; color: var(--muted); margin-top: .4rem; grid-column: 1 / -1; }

        .actions { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
        button {
            padding: .6rem 1.2rem; border: none; border-radius: 8px; font-size: .85rem;
            cursor: pointer; font-weight: 600; transition: opacity .2s;
        }
        button:hover { opacity: .85; }
        button:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        button:disabled { opacity: .4; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        .btn-sm { padding: .35rem .8rem; font-size: .78rem; }

        .spinner { display: none; width: 18px; height: 18px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Stats bar */
        .stats { display: flex; gap: 1.25rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .stat { background: var(--surface); padding: .6rem 1rem; border-radius: 8px; font-size: .82rem; }
        .stat b { display: block; font-size: 1.1rem; margin-bottom: .1rem; }
        .stat.ins b { color: var(--green); }
        .stat.del b { color: var(--red); }
        .stat.mod b { color: var(--yellow); }

        /* Tabs */
        .tabs { display: flex; gap: 0; margin-bottom: 0; }
        .tab {
            padding: .55rem 1rem; background: var(--surface); border: 1px solid var(--border);
            border-bottom: none; cursor: pointer; font-size: .82rem; color: var(--muted);
            border-radius: 8px 8px 0 0; margin-right: -1px;
        }
        .tab:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; z-index: 1; }
        .tab[aria-selected="true"] { background: var(--bg); color: var(--text); font-weight: 600; }

        .tab-content { display: none; border: 1px solid var(--border); border-radius: 0 8px 8px 8px; padding: 1.25rem; background: var(--bg); }
        .tab-content.active { display: block; }

        /* Side-by-side diff */
        .diff-view { display: flex; gap: 0; font-family: 'Fira Code', 'Consolas', monospace; font-size: .8rem; line-height: 1.55; overflow-x: auto; }
        .diff-col { flex: 1; min-width: 0; }
        .diff-col-header { padding: .4rem .75rem; background: var(--surface); font-weight: 600; font-size: .78rem; color: var(--muted); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1; }
        .diff-line { padding: 1px 8px; white-space: pre-wrap; word-break: break-all; min-height: 1.55em; border-bottom: 1px solid rgba(51,65,85,.3); }
        .diff-line.equal { }
        .diff-line.insert { background: var(--green-bg); border-left: 3px solid var(--green); }
        .diff-line.delete { background: var(--red-bg); border-left: 3px solid var(--red); }
        .diff-line.replace { background: var(--yellow-bg); border-left: 3px solid var(--yellow); }
        .diff-line.empty { background: var(--surface); opacity: .4; }
        .diff-line.page-break { background: var(--surface); color: var(--accent); font-weight: 600; text-align: center; font-size: .75rem; padding: .3rem; border-left: none; }
        .diff-gutter { display: inline-block; width: 3.5em; text-align: right; padding-right: .75em; color: var(--muted); user-select: none; opacity: .6; }
        .diff-marker { user-select: none; font-weight: 700; margin-right: .3em; }
        .diff-marker.add { color: var(--green); }
        .diff-marker.del { color: var(--red); }
        .diff-marker.mod { color: var(--yellow); }
        /* Word-level highlight */
        .wdiff-del { background: rgba(239,68,68,.25); border-radius: 2px; padding: 0 1px; text-decoration: line-through; text-decoration-color: var(--red); }
        .wdiff-ins { background: rgba(34,197,94,.25); border-radius: 2px; padding: 0 1px; }

        /* Unified diff */
        .unified-diff { font-family: 'Fira Code', 'Consolas', monospace; font-size: .8rem; line-height: 1.55; white-space: pre-wrap; word-break: break-all; max-height: 600px; overflow: auto; }

        /* Report */
        .report { max-height: 700px; overflow: auto; line-height: 1.65; }
        .report h1 { font-size: 1.3rem; margin-bottom: .5rem; }
        .report h2 { font-size: 1.1rem; margin-top: 1.25rem; margin-bottom: .4rem; color: var(--accent); }
        .report h3 { font-size: .95rem; margin-top: .75rem; margin-bottom: .3rem; }
        .report table { border-collapse: collapse; margin: .6rem 0; width: auto; }
        .report th, .report td { border: 1px solid var(--border); padding: .3rem .65rem; text-align: left; font-size: .82rem; }
        .report th { background: var(--surface); }
        .report hr { border: none; border-top: 1px solid var(--border); margin: .75rem 0; }
        .report ul, .report ol { padding-left: 1.5rem; }
        .report em { color: var(--muted); }

        /* PDF preview */
        .pdf-preview { display: flex; gap: 1rem; }
        .pdf-preview-col { flex: 1; min-width: 0; text-align: center; }
        .pdf-preview-col h4 { font-size: .82rem; color: var(--muted); margin-bottom: .5rem; }
        .pdf-nav { display: flex; gap: .5rem; justify-content: center; align-items: center; margin-bottom: .5rem; font-size: .8rem; }
        .pdf-canvas-wrap { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: #fff; display: flex; justify-content: center; min-height: 300px; }
        .pdf-canvas-wrap canvas { max-width: 100%; height: auto; }

        /* Metadata diff */
        .meta-table { width: 100%; border-collapse: collapse; font-size: .82rem; }
        .meta-table th, .meta-table td { padding: .4rem .75rem; border: 1px solid var(--border); text-align: left; }
        .meta-table th { background: var(--surface); font-weight: 600; }
        .meta-table .changed { background: var(--yellow-bg); }

        /* History sidebar */
        .history-panel { margin-top: 1.5rem; }
        .history-panel h3 { font-size: .9rem; margin-bottom: .5rem; }
        .history-list { list-style: none; max-height: 200px; overflow: auto; }
        .history-list li {
            padding: .5rem .75rem; border: 1px solid var(--border); border-radius: 6px;
            margin-bottom: .35rem; font-size: .8rem; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
            transition: background .15s;
        }
        .history-list li:hover { background: var(--surface); }
        .history-list li .hist-date { color: var(--muted); font-size: .72rem; }
        .history-list li .hist-del {
            color: var(--red); cursor: pointer; font-weight: 700; padding: 0 .3rem;
            background: none; border: none; font-size: inherit; line-height: 1;
        }
        .history-list li .hist-del:focus-visible { outline: 2px solid var(--accent); outline-offset: 1px; }

        /* AI report tab */
        .ai-loading { display: flex; align-items: center; gap: .75rem; color: var(--muted); padding: 2rem 0; }
        .ai-loading .spinner { display: inline-block; }

        #results { display: none; }
    </style>
</head>
<body>
    <a class="skip-link" href="#main-content">Skip to content</a>
    <header>
        <h1>PDFCompare</h1>
        <span>Drop two PDFs to compare their content</span>
    </header>

    <main id="main-content" class="container">
        <div class="drop-area" role="group" aria-label="PDF upload">
            <label class="drop-zone" id="zone-a">
                <input type="file" accept=".pdf" id="file-a" aria-label="Upload Document A (Original)">
                <h3>Document A (Original)</h3>
                <p>Drag &amp; drop or click to select</p>
                <div class="filename" id="name-a" aria-live="polite"></div>
            </label>
            <label class="drop-zone" id="zone-b">
                <input type="file" accept=".pdf" id="file-b" aria-label="Upload Document B (Modified)">
                <h3>Document B (Modified)</h3>
                <p>Drag &amp; drop or click to select</p>
                <div class="filename" id="name-b" aria-live="polite"></div>
            </label>
        </div>

        <div class="settings-row">
            <details class="panel" id="ignore-panel">
                <summary>Ignore Rules</summary>
                <div class="fields">
                    <label class="inline">
                        <input type="checkbox" id="ignore-whitespace"> Ignore whitespace differences
                    </label>
                    <label class="inline">
                        <input type="checkbox" id="ignore-case"> Ignore case differences
                    </label>
                    <label class="inline">
                        <input type="checkbox" id="ignore-headers-footers"> Ignore headers/footers &amp; page numbers
                    </label>
                    <label>
                        Ignore lines matching regex
                        <input type="text" id="ignore-pattern" placeholder="e.g. ^CONFIDENTIAL.*">
                    </label>
                </div>
            </details>

            <details class="panel" id="llm-panel">
                <summary>LLM Configuration</summary>
                <div class="fields">
                    <label>
                        Expert Domain
                        <select id="expert-field" aria-describedby="llm-hint">
                            <option value="">Auto-detect</option>
                            <option value="tax law and international taxation">Tax Law &amp; International Taxation</option>
                            <option value="legal and regulatory compliance">Legal &amp; Regulatory Compliance</option>
                            <option value="contract law">Contract Law</option>
                            <option value="finance and accounting">Finance &amp; Accounting</option>
                            <option value="healthcare and medical sciences">Healthcare &amp; Medical Sciences</option>
                            <option value="software engineering">Software Engineering</option>
                            <option value="insurance">Insurance</option>
                            <option value="intellectual property">Intellectual Property</option>
                            <option value="human resources">Human Resources</option>
                            <option value="environmental science and policy">Environmental Science &amp; Policy</option>
                            <option value="education">Education</option>
                            <option value="real estate">Real Estate</option>
                        </select>
                    </label>
                    <label>
                        Provider
                        <select id="llm-provider" aria-describedby="llm-hint">
                            <option value="">None (built-in report only)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="groq">Groq</option>
                            <option value="kimi">Kimi (Moonshot)</option>
                            <option value="lmstudio">LM Studio (local)</option>
                            <option value="mistral">Mistral AI</option>
                            <option value="ollama">Ollama (local)</option>
                            <option value="openai">OpenAI (ChatGPT)</option>
                            <option value="perplexity">Perplexity</option>
                        </select>
                    </label>
                    <label>
                        Model
                        <input type="text" id="llm-model" placeholder="e.g. llama3, gpt-4o" aria-describedby="llm-hint">
                    </label>
                    <label>
                        API Key
                        <input type="password" id="llm-apikey" placeholder="Not needed for Ollama" aria-describedby="llm-hint">
                    </label>
                    <label>
                        Endpoint
                        <input type="text" id="llm-endpoint" placeholder="Leave blank for default" aria-describedby="llm-hint">
                    </label>
                    <div class="hint" id="llm-hint">
                        <b>Ollama/LM Studio:</b> local, no key &nbsp;|&nbsp;
                        <b>OpenAI:</b> platform.openai.com &nbsp;|&nbsp;
                        <b>Anthropic:</b> console.anthropic.com &nbsp;|&nbsp;
                        <b>Gemini:</b> aistudio.google.com &nbsp;|&nbsp;
                        <b>Mistral:</b> console.mistral.ai &nbsp;|&nbsp;
                        <b>Groq:</b> console.groq.com &nbsp;|&nbsp;
                        <b>DeepSeek:</b> platform.deepseek.com &nbsp;|&nbsp;
                        <b>Kimi:</b> platform.moonshot.cn &nbsp;|&nbsp;
                        <b>Perplexity:</b> perplexity.ai/settings/api
                    </div>
                    <div style="display:flex;gap:.5rem;align-items:center;margin-top:.75rem;">
                        <button class="btn-secondary btn-sm" id="btn-save-llm" type="button">Save Settings</button>
                        <button class="btn-secondary btn-sm" id="btn-clear-llm" type="button">Clear Settings</button>
                        <span id="llm-save-feedback" style="font-size:.75rem;color:var(--green);opacity:0;transition:opacity .3s;"></span>
                    </div>
                </div>
            </details>
        </div>

        <div class="actions">
            <button class="btn-primary" id="btn-compare" disabled>Compare</button>
            <div class="spinner" id="spinner" role="status" aria-label="Comparing documents"></div>
            <button class="btn-secondary" id="btn-export-diff" disabled>Export Diff</button>
            <button class="btn-secondary" id="btn-export-report" disabled>Export Report</button>
            <button class="btn-secondary" id="btn-rerun-ai" disabled>Rerun AI Report</button>
            <button class="btn-secondary" id="btn-export-ai-report" disabled>Export AI Report</button>
            <button class="btn-secondary" id="btn-export-ai-pdf" disabled>Export PDF</button>
        </div>

        <div id="error-banner" role="alert" aria-live="assertive" style="display:none;background:var(--red-bg);border:1px solid var(--red);color:var(--red);padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.85rem;"></div>

        <div id="results">
            <div class="stats" id="stats-bar" aria-label="Comparison statistics"></div>

            <div class="tabs" role="tablist" aria-label="Result views">
                <button class="tab" role="tab" aria-selected="true" aria-controls="tab-side-by-side" id="tab-btn-side-by-side" tabindex="0">Side-by-Side</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-unified" id="tab-btn-unified" tabindex="-1">Unified Diff</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-pdf-preview" id="tab-btn-pdf-preview" tabindex="-1">PDF Preview</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-metadata" id="tab-btn-metadata" tabindex="-1">Metadata</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-report" id="tab-btn-report" tabindex="-1">Report</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-ai-report" id="tab-btn-ai-report" tabindex="-1">AI Report</button>
            </div>

            <div class="tab-content active" id="tab-side-by-side" role="tabpanel" aria-labelledby="tab-btn-side-by-side"></div>
            <div class="tab-content" id="tab-unified" role="tabpanel" aria-labelledby="tab-btn-unified"></div>
            <div class="tab-content" id="tab-pdf-preview" role="tabpanel" aria-labelledby="tab-btn-pdf-preview"></div>
            <div class="tab-content" id="tab-metadata" role="tabpanel" aria-labelledby="tab-btn-metadata"></div>
            <div class="tab-content" id="tab-report" role="tabpanel" aria-labelledby="tab-btn-report"></div>
            <div class="tab-content" id="tab-ai-report" role="tabpanel" aria-labelledby="tab-btn-ai-report"></div>
        </div>

        <div class="history-panel">
            <h3>Comparison History</h3>
            <ul class="history-list" id="history-list"></ul>
        </div>
    </main>

    <footer style="text-align:center;padding:1rem;color:var(--muted);font-size:.75rem;border-top:1px solid var(--border);margin-top:auto;">
        PDFCompare <span id="app-version">v1.0.0</span>
    </footer>

<!-- html2pdf.js for AI report PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="module">
// ── PDF.js setup ────────────────────────────────────────────────────────────
// Dynamically import PDF.js as an ES module and configure its web worker
// for off-thread PDF parsing.  The worker URL must match the library version.
const pdfjsLib = await import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.9.155/pdf.min.mjs");
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.9.155/pdf.worker.min.mjs";

// ── DOM refs ────────────────────────────────────────────────────────────────
const fileA = document.getElementById("file-a");
const fileB = document.getElementById("file-b");
const zoneA = document.getElementById("zone-a");
const zoneB = document.getElementById("zone-b");
const nameA = document.getElementById("name-a");
const nameB = document.getElementById("name-b");
const btnCompare = document.getElementById("btn-compare");
const btnDiff = document.getElementById("btn-export-diff");
const btnReport = document.getElementById("btn-export-report");
const btnAiReport = document.getElementById("btn-export-ai-report");
const btnAiPdf = document.getElementById("btn-export-ai-pdf");
const btnRerunAi = document.getElementById("btn-rerun-ai");
const spinner = document.getElementById("spinner");
const resultsEl = document.getElementById("results");

const expertField = document.getElementById("expert-field");
const llmProvider = document.getElementById("llm-provider");
const llmModel = document.getElementById("llm-model");
const llmApiKey = document.getElementById("llm-apikey");
const llmEndpoint = document.getElementById("llm-endpoint");

let compareResult = null;   // Last comparison response from /api/compare
let changedPagesA = new Set(); // Page numbers in Doc A that contain diffs (used for PDF preview indicators)
let changedPagesB = new Set(); // Page numbers in Doc B that contain diffs
let aiReportText = null;    // Last AI report text (for export)
let lastHistoryId = null;   // ID of most recent history entry (for AI report updates)
let pdfBytesA = null, pdfBytesB = null;   // Raw PDF bytes cached for pdf.js rendering
let pdfDocA = null, pdfDocB = null;       // Parsed pdf.js document objects
let currentPageA = 1, currentPageB = 1;   // Current page index for PDF preview nav

// ── Load server defaults ────────────────────────────────────────────────────
// Fetch non-secret LLM config from the server's .env so the UI fields
// are pre-populated without the user having to re-enter them.
// After loading server config, override with any localStorage values.
const LLM_CONFIG_KEY = "pdfcompare_llm_config";

(async function loadDefaults() {
    try {
        const resp = await fetch("/api/config");
        if (!resp.ok) return;
        const cfg = await resp.json();
        if (cfg.llm_provider && !llmProvider.value) llmProvider.value = cfg.llm_provider;
        if (cfg.llm_model && !llmModel.value) llmModel.value = cfg.llm_model;
        if (cfg.has_api_key) llmApiKey.placeholder = "Set via server .env";
        if (cfg.version) document.getElementById("app-version").textContent = "v" + cfg.version;
    } catch (_) {}

    // Override with localStorage values if present
    loadLlmFromStorage();

    // Set endpoint placeholder based on the active provider
    llmProvider.dispatchEvent(new Event("change"));
})();

function loadLlmFromStorage() {
    try {
        const stored = localStorage.getItem(LLM_CONFIG_KEY);
        if (!stored) return;
        const cfg = JSON.parse(stored);
        if (cfg.provider) llmProvider.value = cfg.provider;
        if (cfg.model) llmModel.value = cfg.model;
        if (cfg.apikey) llmApiKey.value = cfg.apikey;
        if (cfg.endpoint) llmEndpoint.value = cfg.endpoint;
        if (cfg.expert_field) expertField.value = cfg.expert_field;
    } catch (_) {}
}

function saveLlmToStorage() {
    const cfg = {
        provider: llmProvider.value,
        model: llmModel.value,
        apikey: llmApiKey.value,
        endpoint: llmEndpoint.value,
        expert_field: expertField.value
    };
    try {
        localStorage.setItem(LLM_CONFIG_KEY, JSON.stringify(cfg));
        showLlmFeedback("Saved!");
    } catch (_) {
        showLlmFeedback("Failed to save", "var(--red)");
    }
}

async function clearLlmStorage() {
    try {
        localStorage.removeItem(LLM_CONFIG_KEY);
        // Reset to server defaults
        llmProvider.value = "";
        llmModel.value = "";
        llmApiKey.value = "";
        llmEndpoint.value = "";
        expertField.value = "";
        // Reload server defaults
        try {
            const resp = await fetch("/api/config");
            if (resp.ok) {
                const cfg = await resp.json();
                if (cfg.llm_provider) llmProvider.value = cfg.llm_provider;
                if (cfg.llm_model) llmModel.value = cfg.llm_model;
                if (cfg.llm_endpoint) llmEndpoint.placeholder = cfg.llm_endpoint;
                if (cfg.has_api_key) llmApiKey.placeholder = "Set via server .env";
            }
        } catch (_) {}
        showLlmFeedback("Cleared!");
    } catch (_) {}
}

function showLlmFeedback(msg, color = "var(--green)") {
    const el = document.getElementById("llm-save-feedback");
    el.textContent = msg;
    el.style.color = color;
    el.style.opacity = "1";
    setTimeout(() => { el.style.opacity = "0"; }, 1500);
}

llmProvider.addEventListener("change", () => {
    const defaults = { ollama: "llama3.3:70b", lmstudio: "default", openai: "gpt-5.2", anthropic: "claude-opus-4-5-20251101", gemini: "gemini-3-pro", mistral: "mistral-large-3", groq: "llama-3.3-70b-versatile", deepseek: "deepseek-chat", kimi: "kimi-k2.5", perplexity: "sonar-pro" };
    const endpoints = { ollama: "http://localhost:11434", lmstudio: "http://localhost:1234/v1/chat/completions", openai: "https://api.openai.com/v1/chat/completions", anthropic: "https://api.anthropic.com/v1/messages", gemini: "https://generativelanguage.googleapis.com/v1beta/models/", mistral: "https://api.mistral.ai/v1/chat/completions", groq: "https://api.groq.com/openai/v1/chat/completions", deepseek: "https://api.deepseek.com/chat/completions", kimi: "https://api.moonshot.cn/v1/chat/completions", perplexity: "https://api.perplexity.ai/chat/completions" };
    if (defaults[llmProvider.value]) llmModel.value = defaults[llmProvider.value];
    llmEndpoint.placeholder = endpoints[llmProvider.value] || "Leave blank for default";
});

// Wire up Save and Clear buttons
document.getElementById("btn-save-llm").addEventListener("click", saveLlmToStorage);
document.getElementById("btn-clear-llm").addEventListener("click", clearLlmStorage);

// ── Drop zones ──────────────────────────────────────────────────────────────
// Wire up drag-and-drop and file-input events for each upload zone.
// When a PDF is selected, its bytes are cached (for pdf.js preview later)
// and the Compare button is enabled once both slots have files.
function setupZone(zone, input, nameEl, side) {
    ["dragover", "dragenter"].forEach(e => zone.addEventListener(e, ev => { ev.preventDefault(); zone.classList.add("dragover"); }));
    ["dragleave", "drop"].forEach(e => zone.addEventListener(e, () => zone.classList.remove("dragover")));
    zone.addEventListener("drop", ev => {
        ev.preventDefault();
        const file = ev.dataTransfer.files[0];
        if (file && file.name.toLowerCase().endsWith(".pdf")) {
            const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
            nameEl.textContent = file.name; zone.classList.add("has-file");
            cacheFile(file, side); checkReady();
        }
    });
    input.addEventListener("change", () => {
        if (input.files[0]) {
            nameEl.textContent = input.files[0].name; zone.classList.add("has-file");
            cacheFile(input.files[0], side); checkReady();
        }
    });
}

async function cacheFile(file, side) {
    const buf = await file.arrayBuffer();
    if (side === "a") { pdfBytesA = new Uint8Array(buf); pdfDocA = null; }
    else { pdfBytesB = new Uint8Array(buf); pdfDocB = null; }
}

setupZone(zoneA, fileA, nameA, "a");
setupZone(zoneB, fileB, nameB, "b");

function checkReady() { btnCompare.disabled = !(fileA.files[0] && fileB.files[0]); }

// ── Tabs ────────────────────────────────────────────────────────────────────
// ARIA-compliant tab widget: click or arrow-key to switch panels.
// Only the active tab is in the tab order (tabindex=0); others are -1.
const tabButtons = document.querySelectorAll('[role="tab"]');
const tabPanels = document.querySelectorAll('[role="tabpanel"]');

function activateTab(tab) {
    tabButtons.forEach(t => { t.setAttribute("aria-selected", "false"); t.tabIndex = -1; });
    tabPanels.forEach(p => p.classList.remove("active"));
    tab.setAttribute("aria-selected", "true"); tab.tabIndex = 0; tab.focus();
    document.getElementById(tab.getAttribute("aria-controls")).classList.add("active");
}

tabButtons.forEach(tab => {
    tab.addEventListener("click", () => activateTab(tab));
    tab.addEventListener("keydown", ev => {
        const tabs = [...tabButtons]; const idx = tabs.indexOf(tab); let target = null;
        if (ev.key === "ArrowRight") target = tabs[(idx + 1) % tabs.length];
        else if (ev.key === "ArrowLeft") target = tabs[(idx - 1 + tabs.length) % tabs.length];
        else if (ev.key === "Home") target = tabs[0];
        else if (ev.key === "End") target = tabs[tabs.length - 1];
        if (target) { ev.preventDefault(); activateTab(target); }
    });
});

// ── Compare ─────────────────────────────────────────────────────────────────
btnCompare.addEventListener("click", async () => {
    const form = new FormData();
    clearError();
    form.append("pdf_a", fileA.files[0]);
    form.append("pdf_b", fileB.files[0]);

    // Ignore rules
    if (document.getElementById("ignore-whitespace").checked) form.append("ignore_whitespace", "true");
    if (document.getElementById("ignore-case").checked) form.append("ignore_case", "true");
    if (document.getElementById("ignore-headers-footers").checked) form.append("ignore_headers_footers", "true");
    const pat = document.getElementById("ignore-pattern").value.trim();
    if (pat) form.append("ignore_pattern", pat);

    btnCompare.disabled = true;
    spinner.style.display = "block";
    resultsEl.style.display = "none";

    try {
        const resp = await fetch("/api/compare", { method: "POST", body: form });
        const data = await resp.json();
        if (!resp.ok) { showError(data.error || "Comparison failed."); return; }
        compareResult = data;
        aiReportText = null;
        renderResults(data);
        resultsEl.style.display = "block";
        resultsEl.scrollIntoView({ behavior: "smooth" });
        resultsEl.setAttribute("tabindex", "-1");
        resultsEl.focus({ preventScroll: true });
        btnDiff.disabled = false;
        btnReport.disabled = false;
        saveToHistory(data);
        renderHistory();

        if (llmProvider.value) { requestAiReport(data); }
        else {
            document.getElementById("tab-ai-report").innerHTML =
                '<div class="report" style="color:var(--muted);padding:2rem 0;">Configure an LLM provider above and re-run the comparison to generate an AI-powered report.</div>';
        }
    } catch (e) {
        showError("Request failed: " + e.message);
    } finally {
        btnCompare.disabled = false;
        spinner.style.display = "none";
    }
});

// ── AI report ───────────────────────────────────────────────────────────────
// Send the unified diff + stats to /api/llm-report for AI-powered analysis.
// Shows a spinner while waiting and renders the Markdown response in the
// AI Report tab.
async function requestAiReport(data) {
    const aiTab = document.getElementById("tab-ai-report");
    aiTab.innerHTML = '<div class="ai-loading" role="status" aria-label="Generating AI report"><div class="spinner" style="display:inline-block"></div> Generating AI report&hellip;</div>';
    btnAiReport.disabled = true;
    btnAiPdf.disabled = true;
    btnRerunAi.disabled = true;

    const cfg = {};
    if (llmModel.value) cfg.model = llmModel.value;
    if (llmApiKey.value) cfg.api_key = llmApiKey.value;
    if (llmEndpoint.value) cfg.endpoint = llmEndpoint.value;

    try {
        const resp = await fetch("/api/llm-report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ provider: llmProvider.value, config: cfg, unified_diff: data.unified_diff, stats: data.stats, name_a: data.name_a, name_b: data.name_b, expert_field: expertField.value || "" }),
        });
        const result = await resp.json();
        if (!resp.ok) { aiTab.innerHTML = `<div class="report" role="alert" style="color:var(--red);">LLM Error: ${esc(result.error || "Unknown error")}</div>`; btnRerunAi.disabled = false; return; }
        aiReportText = result.report;
        aiTab.innerHTML = `<div class="report" id="ai-report-content">${renderMarkdown(result.report)}</div>`;
        btnAiReport.disabled = false;
        btnAiPdf.disabled = false;
        btnRerunAi.disabled = false;
        updateHistoryAiReport(lastHistoryId, aiReportText);
    } catch (e) {
        aiTab.innerHTML = `<div class="report" role="alert" style="color:var(--red);">Request failed: ${esc(e.message)}</div>`;
        btnRerunAi.disabled = false;
    }
}

// ── Render results ──────────────────────────────────────────────────────────
function renderResults(data) {
    const s = data.stats;
    document.getElementById("stats-bar").innerHTML = `
        <dl class="stats" style="display:flex;gap:1.25rem;flex-wrap:wrap;margin:0;">
            <div class="stat"><dt style="font-size:.82rem;">Unchanged</dt><dd style="font-size:1.1rem;font-weight:700;">${s.equal}</dd></div>
            <div class="stat ins"><dt style="font-size:.82rem;">Inserted</dt><dd style="font-size:1.1rem;font-weight:700;color:var(--green);">+${s.insert}</dd></div>
            <div class="stat del"><dt style="font-size:.82rem;">Deleted</dt><dd style="font-size:1.1rem;font-weight:700;color:var(--red);">-${s.delete}</dd></div>
            <div class="stat mod"><dt style="font-size:.82rem;">Modified</dt><dd style="font-size:1.1rem;font-weight:700;color:var(--yellow);">~${s.replace}</dd></div>
        </dl>
    `;

    renderSideBySide(data);
    document.getElementById("tab-unified").innerHTML = `<div class="unified-diff">${esc(data.unified_diff)}</div>`;
    document.getElementById("tab-report").innerHTML = `<div class="report">${renderMarkdown(data.report)}</div>`;
    renderMetadataTab(data);
    buildChangedPageSets(data);
    renderPdfPreviewTab();
}

// ── Side-by-side with word-level diffs and page markers ─────────────────────
// Builds two parallel columns of diff lines.  Page-break separators are
// inserted when the page number changes.  Replace blocks use word-level
// spans (wdiff-del / wdiff-ins) for finer highlighting when available.
function renderSideBySide(data) {
    let leftHtml = `<div class="diff-col-header">${esc(data.name_a)}</div>`;
    let rightHtml = `<div class="diff-col-header">${esc(data.name_b)}</div>`;
    let lastLeftPage = null, lastRightPage = null;

    for (const block of data.diff_blocks) {
        // Insert page break markers
        if (block.left_page && block.left_page !== lastLeftPage) {
            leftHtml += `<div class="diff-line page-break" role="separator" aria-label="Page ${block.left_page}">— Page ${block.left_page} —</div>`;
            lastLeftPage = block.left_page;
        }
        if (block.right_page && block.right_page !== lastRightPage) {
            rightHtml += `<div class="diff-line page-break" role="separator" aria-label="Page ${block.right_page}">— Page ${block.right_page} —</div>`;
            lastRightPage = block.right_page;
        }

        const maxLen = Math.max(block.left_lines.length, block.right_lines.length);
        for (let i = 0; i < maxLen; i++) {
            const hasLeft = i < block.left_lines.length;
            const hasRight = i < block.right_lines.length;
            const lnum = hasLeft ? block.left_start + i + 1 : "";
            const rnum = hasRight ? block.right_start + i + 1 : "";
            const lClass = !hasLeft ? "empty" : (block.tag === "equal" ? "equal" : block.tag === "delete" ? "delete" : "replace");
            const rClass = !hasRight ? "empty" : (block.tag === "equal" ? "equal" : block.tag === "insert" ? "insert" : "replace");

            let lMarker = "", rMarker = "";
            if (block.tag === "delete" && hasLeft) lMarker = '<span class="diff-marker del" role="img" aria-label="deleted">-</span>';
            if (block.tag === "insert" && hasRight) rMarker = '<span class="diff-marker add" role="img" aria-label="added">+</span>';
            if (block.tag === "replace" && hasLeft) lMarker = '<span class="diff-marker mod" role="img" aria-label="modified">~</span>';
            if (block.tag === "replace" && hasRight) rMarker = '<span class="diff-marker mod" role="img" aria-label="modified">~</span>';

            // Word-level highlighting for replace blocks
            let lContent = hasLeft ? esc(block.left_lines[i]) : "";
            let rContent = hasRight ? esc(block.right_lines[i]) : "";

            if (block.tag === "replace" && block.word_diffs && block.word_diffs[i]) {
                const wd = block.word_diffs[i];
                if (hasLeft) lContent = renderWordSpans(wd.left_spans, "left");
                if (hasRight) rContent = renderWordSpans(wd.right_spans, "right");
            }

            leftHtml += `<div class="diff-line ${lClass}"><span class="diff-gutter">${lnum}</span>${lMarker}${lContent}</div>`;
            rightHtml += `<div class="diff-line ${rClass}"><span class="diff-gutter">${rnum}</span>${rMarker}${rContent}</div>`;
        }
    }
    document.getElementById("tab-side-by-side").innerHTML = `<div class="diff-view"><div class="diff-col">${leftHtml}</div><div class="diff-col">${rightHtml}</div></div>`;
}

function renderWordSpans(spans, side) {
    return spans.map(([text, type]) => {
        const escaped = esc(text);
        if (type === "equal") return escaped + " ";
        if (side === "left") return `<span class="wdiff-del">${escaped}</span> `;
        return `<span class="wdiff-ins">${escaped}</span> `;
    }).join("");
}

// ── Metadata tab ────────────────────────────────────────────────────────────
function renderMetadataTab(data) {
    const fields = ["title", "author", "subject", "creator", "producer", "creation_date", "mod_date", "page_count"];
    const labels = { title: "Title", author: "Author", subject: "Subject", creator: "Creator", producer: "Producer", creation_date: "Creation Date", mod_date: "Modification Date", page_count: "Page Count" };
    const changedFields = new Set((data.metadata_diff || []).map(d => d.field));

    let html = '<table class="meta-table"><thead><tr><th>Field</th><th>Document A</th><th>Document B</th></tr></thead><tbody>';
    for (const f of fields) {
        const cls = changedFields.has(f) ? ' class="changed"' : '';
        html += `<tr${cls}><td><strong>${labels[f] || f}</strong></td><td>${esc(String(data.metadata_a[f] || "—"))}</td><td>${esc(String(data.metadata_b[f] || "—"))}</td></tr>`;
    }
    html += '</tbody></table>';

    if (data.metadata_diff && data.metadata_diff.length > 0) {
        html += `<p style="margin-top:.75rem;font-size:.82rem;color:var(--yellow);">${data.metadata_diff.length} metadata field(s) differ between documents.</p>`;
    } else {
        html += '<p style="margin-top:.75rem;font-size:.82rem;color:var(--muted);">Metadata is identical.</p>';
    }
    document.getElementById("tab-metadata").innerHTML = html;
}

// ── Build sets of pages that contain diffs ───────────────────────────────────
// Scans diff_blocks to collect page numbers where changes exist.
// These sets drive the visual indicators (yellow border + label) in the
// PDF preview tab so users can quickly identify modified pages.
function buildChangedPageSets(data) {
    changedPagesA = new Set();
    changedPagesB = new Set();
    if (!data || !data.diff_blocks) return;
    for (const block of data.diff_blocks) {
        if (block.tag === "equal") continue;
        if (block.left_page) changedPagesA.add(block.left_page);
        if (block.right_page) changedPagesB.add(block.right_page);
    }
}

// ── PDF preview tab ─────────────────────────────────────────────────────────
function renderPdfPreviewTab() {
    document.getElementById("tab-pdf-preview").innerHTML = `
        <div class="pdf-preview">
            <div class="pdf-preview-col">
                <h4>Document A</h4>
                <div class="pdf-nav">
                    <button class="btn-secondary btn-sm" id="pdf-a-prev" aria-label="Previous page, Document A">Prev</button>
                    <span id="pdf-a-info">Page 1</span>
                    <button class="btn-secondary btn-sm" id="pdf-a-next" aria-label="Next page, Document A">Next</button>
                </div>
                <div class="pdf-canvas-wrap"><canvas id="pdf-canvas-a" aria-label="PDF preview of Document A" role="img"></canvas></div>
            </div>
            <div class="pdf-preview-col">
                <h4>Document B</h4>
                <div class="pdf-nav">
                    <button class="btn-secondary btn-sm" id="pdf-b-prev" aria-label="Previous page, Document B">Prev</button>
                    <span id="pdf-b-info">Page 1</span>
                    <button class="btn-secondary btn-sm" id="pdf-b-next" aria-label="Next page, Document B">Next</button>
                </div>
                <div class="pdf-canvas-wrap"><canvas id="pdf-canvas-b" aria-label="PDF preview of Document B" role="img"></canvas></div>
            </div>
        </div>
    `;

    currentPageA = 1; currentPageB = 1;
    loadPdfDocs().then(() => {
        renderPdfPage("a"); renderPdfPage("b");
    });

    document.getElementById("pdf-a-prev").addEventListener("click", () => { if (currentPageA > 1) { currentPageA--; renderPdfPage("a"); } });
    document.getElementById("pdf-a-next").addEventListener("click", () => { if (pdfDocA && currentPageA < pdfDocA.numPages) { currentPageA++; renderPdfPage("a"); } });
    document.getElementById("pdf-b-prev").addEventListener("click", () => { if (currentPageB > 1) { currentPageB--; renderPdfPage("b"); } });
    document.getElementById("pdf-b-next").addEventListener("click", () => { if (pdfDocB && currentPageB < pdfDocB.numPages) { currentPageB++; renderPdfPage("b"); } });
}

async function loadPdfDocs() {
    try {
        if (pdfBytesA && !pdfDocA) pdfDocA = await pdfjsLib.getDocument({ data: pdfBytesA.slice() }).promise;
        if (pdfBytesB && !pdfDocB) pdfDocB = await pdfjsLib.getDocument({ data: pdfBytesB.slice() }).promise;
    } catch (e) {
        console.warn("PDF.js load failed:", e);
    }
}

async function renderPdfPage(side) {
    const doc = side === "a" ? pdfDocA : pdfDocB;
    const pageNum = side === "a" ? currentPageA : currentPageB;
    const canvas = document.getElementById(`pdf-canvas-${side}`);
    const info = document.getElementById(`pdf-${side}-info`);
    if (!doc) {
        const wrap = canvas && canvas.closest(".pdf-canvas-wrap");
        if (wrap) wrap.innerHTML = '<div style="color:var(--muted);padding:2rem;text-align:center;">PDF preview unavailable</div>';
        return;
    }
    if (!canvas) return;

    // Highlight pages that contain diffs: yellow border + "• Changes" label
    const changedPages = side === "a" ? changedPagesA : changedPagesB;
    const hasChanges = changedPages.has(pageNum);
    info.textContent = `Page ${pageNum} / ${doc.numPages}` + (hasChanges ? " \u2022 Changes" : "");
    const wrap = canvas.closest(".pdf-canvas-wrap");
    if (wrap) {
        wrap.style.borderColor = hasChanges ? "var(--yellow)" : "var(--border)";
        wrap.style.borderWidth = hasChanges ? "3px" : "1px";
    }
    const page = await doc.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.5 });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
}

// ── History (localStorage) ──────────────────────────────────────────────────
// Persist the last MAX_HISTORY comparison results in localStorage so users
// can revisit them without re-uploading.  Word-level diffs are stripped
// before saving to reduce storage size.
const HISTORY_KEY = "pdfcompare_history";
const MAX_HISTORY = 20;

function getHistory() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); } catch { return []; }
}

function saveToHistory(data) {
    const history = getHistory();
    const entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        name_a: data.name_a,
        name_b: data.name_b,
        stats: data.stats,
        report: data.report,
        ai_report: aiReportText,
        unified_diff: data.unified_diff,
    };
    lastHistoryId = entry.id;
    history.unshift(entry);
    if (history.length > MAX_HISTORY) history.length = MAX_HISTORY;
    try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch {
        // Quota exceeded — remove oldest entry and retry once
        if (history.length > 1) {
            history.pop();
            try { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); } catch { /* still full */ }
        }
    }
}

function renderHistory() {
    const list = document.getElementById("history-list");
    const history = getHistory();
    if (history.length === 0) { list.innerHTML = '<li style="color:var(--muted);cursor:default;">No history yet</li>'; return; }

    list.innerHTML = history.map(h => {
        const d = new Date(h.date);
        const label = `${h.name_a} vs ${h.name_b}`;
        const dateStr = d.toLocaleDateString() + " " + d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        const changed = h.stats.insert + h.stats.delete + h.stats.replace;
        return `<li data-id="${h.id}" tabindex="0" role="button" aria-label="Load comparison: ${esc(label)}"><div><strong>${esc(label)}</strong><br><span class="hist-date">${dateStr} — ${changed} change(s)</span></div><button class="hist-del" data-del="${h.id}" title="Remove from history" aria-label="Remove ${esc(label)}">&times;</button></li>`;
    }).join("");

    list.querySelectorAll("li[data-id]").forEach(li => {
        function handleActivate(ev) {
            if (ev.target.classList.contains("hist-del")) {
                ev.stopPropagation();
                deleteHistoryEntry(parseInt(ev.target.dataset.del));
                return;
            }
            const id = parseInt(li.dataset.id);
            const entry = getHistory().find(h => h.id === id);
            if (entry) { loadFromHistory(entry); }
        }
        li.addEventListener("click", handleActivate);
        li.addEventListener("keydown", ev => {
            if (ev.key === "Enter" || ev.key === " ") { ev.preventDefault(); handleActivate(ev); }
        });
    });
}

function deleteHistoryEntry(id) {
    const history = getHistory().filter(h => h.id !== id);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    renderHistory();
}

function updateHistoryAiReport(id, text) {
    if (!id) return;
    const history = getHistory();
    const entry = history.find(h => h.id === id);
    if (!entry) return;
    entry.ai_report = text;
    try { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); } catch { /* quota */ }
}

function loadFromHistory(entry) {
    aiReportText = entry.ai_report || null;
    lastHistoryId = entry.id;
    buildChangedPageSets(entry);
    resultsEl.style.display = "block";
    btnDiff.disabled = !entry.unified_diff;
    btnReport.disabled = !entry.report;
    btnAiReport.disabled = !entry.ai_report;
    btnAiPdf.disabled = !entry.ai_report;

    const s = entry.stats;
    document.getElementById("stats-bar").innerHTML = `
        <dl class="stats" style="display:flex;gap:1.25rem;flex-wrap:wrap;margin:0;">
            <div class="stat"><dt style="font-size:.82rem;">Unchanged</dt><dd style="font-size:1.1rem;font-weight:700;">${s.equal}</dd></div>
            <div class="stat ins"><dt style="font-size:.82rem;">Inserted</dt><dd style="font-size:1.1rem;font-weight:700;color:var(--green);">+${s.insert}</dd></div>
            <div class="stat del"><dt style="font-size:.82rem;">Deleted</dt><dd style="font-size:1.1rem;font-weight:700;color:var(--red);">-${s.delete}</dd></div>
            <div class="stat mod"><dt style="font-size:.82rem;">Modified</dt><dd style="font-size:1.1rem;font-weight:700;color:var(--yellow);">~${s.replace}</dd></div>
        </dl>
    `;
    document.getElementById("tab-side-by-side").innerHTML = '<div style="color:var(--muted);padding:2rem 0;">Side-by-side diff is not available for history entries. Re-upload the files to view full results.</div>';
    document.getElementById("tab-unified").innerHTML = entry.unified_diff ? `<div class="unified-diff">${esc(entry.unified_diff)}</div>` : '<div style="color:var(--muted);padding:2rem 0;">Unified diff is not available for history entries.</div>';
    document.getElementById("tab-pdf-preview").innerHTML = '<div style="color:var(--muted);padding:2rem 0;">PDF preview is not available for history entries.</div>';
    document.getElementById("tab-metadata").innerHTML = '<div style="color:var(--muted);padding:2rem 0;">Metadata is not available for history entries.</div>';
    document.getElementById("tab-report").innerHTML = entry.report ? `<div class="report">${renderMarkdown(entry.report)}</div>` : '<div style="color:var(--muted);padding:2rem 0;">No report available.</div>';
    document.getElementById("tab-ai-report").innerHTML = entry.ai_report ? `<div class="report" id="ai-report-content">${renderMarkdown(entry.ai_report)}</div>` : '<div style="color:var(--muted);padding:2rem 0;">AI report is not available for history entries. Use "Rerun AI Report" to generate one.</div>';

    // Allow exporting the report and rerunning AI from history
    compareResult = entry;
    btnRerunAi.disabled = !entry.unified_diff;
}

// Load history on startup
renderHistory();

// ── Helpers ─────────────────────────────────────────────────────────────────

function showError(msg) {
    const banner = document.getElementById("error-banner");
    banner.textContent = msg;
    banner.style.display = "block";
    banner.scrollIntoView({ behavior: "smooth", block: "nearest" });
}
function clearError() {
    const banner = document.getElementById("error-banner");
    banner.textContent = "";
    banner.style.display = "none";
}

/**
 * HTML-escape a string to prevent XSS when inserting user-supplied text.
 * Uses a temporary DOM element (textContent → innerHTML) for correctness.
 */
function esc(s) {
    const d = document.createElement("div"); d.textContent = s; return d.innerHTML;
}

/**
 * Lightweight Markdown → HTML converter.  Handles headings, bold, italic,
 * horizontal rules, lists, and pipe-delimited tables.  Input is first
 * HTML-escaped via esc() to prevent injection from LLM output.
 */
function renderMarkdown(md) {
    // Strip outer markdown code fence if LLM wrapped the response in one
    md = md.replace(/^```(?:markdown)?\s*\n?/i, "").replace(/\n?```\s*$/, "");
    let html = esc(md);
    html = html.replace(/^### (.+)$/gm, "<h3>$1</h3>");
    html = html.replace(/^## (.+)$/gm, "<h2>$1</h2>");
    html = html.replace(/^# (.+)$/gm, "<h1>$1</h1>");
    html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
    html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
    html = html.replace(/^---$/gm, "<hr>");
    html = html.replace(/^\- (.+)$/gm, "<li>$1</li>");
    html = html.replace(/^\d+\. (.+)$/gm, "<li>$1</li>");
    html = html.replace(/\|(.+)\|/g, (match) => {
        const cells = match.split("|").filter(c => c.trim()).map(c => c.trim());
        if (cells.every(c => /^[\-\|]+$/.test(c))) return "";
        return "<tr>" + cells.map(c => `<td>${c}</td>`).join("") + "</tr>";
    });
    html = html.replace(/(<tr>.*<\/tr>\s*)+/gs, (m) => `<table>${m}</table>`);
    html = html.replace(/(<li>.*<\/li>\s*)+/gs, (m) => `<ul>${m}</ul>`);
    html = html.replace(/\n/g, "<br>");
    return html;
}

/** Trigger a browser download of a string as a file. */
function download(content, filename, type) {
    const blob = new Blob([content], { type });
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
    a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

// ── Export buttons ──────────────────────────────────────────────────────────
btnDiff.addEventListener("click", () => { if (compareResult) download(compareResult.unified_diff, "diff.patch", "text/plain"); });
btnReport.addEventListener("click", () => { if (compareResult) download(compareResult.report, "comparison-report.md", "text/markdown"); });
btnAiReport.addEventListener("click", () => {
    if (!aiReportText) return;
    // Strip outer markdown code fence if present
    const cleaned = aiReportText.replace(/^```(?:markdown)?\s*\n?/i, "").replace(/\n?```\s*$/, "");
    download(cleaned, "ai-comparison-report.md", "text/markdown");
});
btnRerunAi.addEventListener("click", () => {
    if (!compareResult || !llmProvider.value) return;
    // Switch to AI Report tab
    document.querySelectorAll(".tab").forEach(t => t.setAttribute("aria-selected", "false"));
    document.getElementById("tab-btn-ai-report").setAttribute("aria-selected", "true");
    document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");
    document.getElementById("tab-ai-report").style.display = "block";
    requestAiReport(compareResult);
});

// Export AI report as PDF using html2pdf.js
// We build a standalone HTML string with embedded styles to avoid inheriting
// the app's dark theme (which causes white-on-white text in the PDF).
btnAiPdf.addEventListener("click", () => {
    const reportContent = document.getElementById("ai-report-content");
    if (!reportContent) return;

    const htmlString = `<div style="font-family:Arial,Helvetica,sans-serif;font-size:12pt;line-height:1.7;color:#111;padding:0;margin:0;width:680px;max-width:680px;overflow-wrap:break-word;word-wrap:break-word;box-sizing:border-box;">
        <style>
            * { color: #111 !important; box-sizing: border-box; }
            h1 { font-size: 18pt; margin: 18px 0 10px; border-bottom: 2px solid #333; padding-bottom: 4px; }
            h2 { font-size: 15pt; margin: 16px 0 8px; border-bottom: 1px solid #999; padding-bottom: 3px; }
            h3 { font-size: 13pt; margin: 14px 0 6px; }
            strong { font-weight: 700; }
            em { font-style: italic; }
            hr { border: none; border-top: 1px solid #ccc; margin: 12px 0; }
            ul, ol { margin: 6px 0 6px 20px; padding: 0; }
            li { margin-bottom: 4px; page-break-inside: avoid; break-inside: avoid; }
            p { page-break-inside: avoid; break-inside: avoid; }
            h1, h2, h3 { page-break-after: avoid; break-after: avoid; }
            table { border-collapse: collapse; width: 100%; margin: 10px 0; page-break-inside: avoid; break-inside: avoid; }
            td, th { border: 1px solid #999; padding: 5px 8px; text-align: left; font-size: 10pt; overflow-wrap: break-word; word-wrap: break-word; max-width: 200px; }
            tr { page-break-inside: avoid; break-inside: avoid; }
            tr:nth-child(even) { background: #f5f5f5; }
            br { display: block; content: ""; margin-top: 2px; }
        </style>
        ${reportContent.innerHTML}
    </div>`;

    const opt = {
        margin: [15, 15, 15, 15],
        filename: "ai-comparison-report.pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0, windowWidth: 680 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak: { mode: ["css", "legacy"] }
    };

    html2pdf().set(opt).from(htmlString, "string").save();
});
</script>
</body>
</html>
